<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PdfFlow - Professional PDF Editor</title>
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>

    <style>
        :root {
            --primary-dark: #2c3e50;
            --accent-blue: #007bff;
            --toolbar-bg: #f8f9fa;
            --viewer-bg: #e4e4e4;
        }

        body, html { height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        /* Toolbar Styling */
        .main-navbar {
            background: var(--primary-dark);
            height: 50px;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .secondary-toolbar {
            background: var(--toolbar-bg);
            border-bottom: 1px solid #ddd;
            height: 45px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
        }

        .tool-btn {
            border: none;
            background: transparent;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            color: #555;
            transition: 0.2s;
        }

        .tool-btn:hover { background: #e2e6ea; color: #000; }
        .tool-btn.active { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Layout */
        #main-container {
            display: flex;
            height: calc(100vh - 95px);
            background: var(--viewer-bg);
        }

        #sidebar {
            width: 200px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        #viewer-scroll {
            flex-grow: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* PDF Page Container */
        .pdf-page-container {
            position: relative;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }

        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        /* Empty State */
        #empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            color: #777;
        }

        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            background: white;
            cursor: pointer;
        }

        /* Spinner */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); display: none;
            z-index: 9999; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary"></div></div>

<!-- Top Bar -->
<div class="main-navbar">
    <h5 class="m-0"><i class="bi bi-file-pdf-fill text-danger"></i> PdfFlow</h5>
    <div class="ms-auto">
        <button class="btn btn-sm btn-outline-light me-2" onclick="document.getElementById('fileInput').click()">
            <i class="bi bi-upload"></i> Open File
        </button>
        <button class="btn btn-sm btn-primary" id="savePdf">
            <i class="bi bi-download"></i> Export PDF
        </button>
    </div>
</div>

<!-- Toolbar -->
<div class="secondary-toolbar">
    <button class="tool-btn active" id="btn-select" onclick="setMode('select')" title="Selection Tool">
        <i class="bi bi-cursor"></i>
    </button>
    <button class="tool-btn" id="btn-text" onclick="setMode('text')" title="Add Text">
        <i class="bi bi-fonts"></i>
    </button>
    <button class="tool-btn" id="btn-draw" onclick="setMode('draw')" title="Freehand Draw">
        <i class="bi bi-pencil"></i>
    </button>
    <div class="vr mx-1"></div>
    <button class="tool-btn" onclick="zoomIn()"><i class="bi bi-zoom-in"></i></button>
    <span id="zoom-text" style="font-size: 12px;">100%</span>
    <button class="tool-btn" onclick="zoomOut()"><i class="bi bi-zoom-out"></i></button>
    <div class="vr mx-1"></div>
    <button class="tool-btn text-danger" id="btn-delete" onclick="deleteObject()" title="Delete Selected">
        <i class="bi bi-trash"></i>
    </button>
</div>

<div id="main-container">
    <!-- Sidebar Thumbnails -->
    <div id="sidebar">
        <p class="small text-muted text-center">Thumbnails</p>
        <div id="thumbnails"></div>
    </div>

    <!-- Viewer -->
    <div id="viewer-scroll">
        <div id="empty-state">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-cloud-arrow-up" style="font-size: 3rem;"></i>
                <h4>Click to Upload PDF</h4>
                <p>Editing logic runs locally in your browser.</p>
            </div>
        </div>
        <div id="pdf-content"></div>
    </div>
</div>

<input type="file" id="fileInput" hidden accept="application/pdf">

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let currentPdf = null;
    let pdfDocInstance = null;
    let fabricCanvases = [];
    let scale = 1.3;

    // --- File Loading ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        showLoader(true);
        const arrayBuffer = await file.arrayBuffer();
        
        // Load for Rendering
        currentPdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        // Load for Editing/Saving
        pdfDocInstance = await PDFLib.PDFDocument.load(arrayBuffer);

        renderFullPdf();
        document.getElementById('empty-state').style.display = 'none';
    });

    async function renderFullPdf() {
        const container = document.getElementById('pdf-content');
        container.innerHTML = '';
        fabricCanvases = [];

        for (let i = 1; i <= currentPdf.numPages; i++) {
            const page = await currentPdf.getPage(i);
            const viewport = page.getViewport({ scale });

            // Create Page Wrapper
            const pageDiv = document.createElement('div');
            pageDiv.className = 'pdf-page-container';
            pageDiv.style.width = `${viewport.width}px`;
            pageDiv.style.height = `${viewport.height}px`;
            container.appendChild(pageDiv);

            // 1. Render PDF Canvas (Background)
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            pageDiv.appendChild(canvas);
            await page.render({ canvasContext: context, viewport }).promise;

            // 2. Create Fabric Overlay (Foreground)
            const overlayCanvas = document.createElement('canvas');
            overlayCanvas.className = 'canvas-overlay';
            pageDiv.appendChild(overlayCanvas);

            const fCanvas = new fabric.Canvas(overlayCanvas, {
                width: viewport.width,
                height: viewport.height,
                selection: true
            });
            
            fabricCanvases.push(fCanvas);
            setupCanvasEvents(fCanvas);
        }
        showLoader(false);
    }

    // --- Tools Logic ---
    function setMode(mode) {
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${mode}`).classList.add('active');

        fabricCanvases.forEach(canvas => {
            canvas.isDrawingMode = (mode === 'draw');
            if (mode === 'draw') {
                canvas.freeDrawingBrush.width = 3;
                canvas.freeDrawingBrush.color = "red";
            }
            // Add text if mode is text
            canvas.off('mouse:down');
            if (mode === 'text') {
                canvas.on('mouse:down', function(options) {
                    if (options.target) return;
                    const text = new fabric.IText('Double click to edit', {
                        left: options.pointer.x,
                        top: options.pointer.y,
                        fontSize: 20,
                        fontFamily: 'Arial',
                        fill: '#000'
                    });
                    canvas.add(text);
                    setMode('select');
                });
            }
        });
    }

    function deleteObject() {
        fabricCanvases.forEach(canvas => {
            const active = canvas.getActiveObject();
            if (active) canvas.remove(active);
        });
    }

    function zoomIn() { scale += 0.2; updateZoom(); }
    function zoomOut() { if(scale > 0.6) scale -= 0.2; updateZoom(); }
    function updateZoom() {
        document.getElementById('zoom-text').innerText = Math.round(scale * 100) + '%';
        if(currentPdf) renderFullPdf();
    }

    // --- Saving / Export ---
    document.getElementById('savePdf').addEventListener('click', async () => {
        showLoader(true);
        const pdfPages = pdfDocInstance.getPages();

        for (let i = 0; i < fabricCanvases.length; i++) {
            const fCanvas = fabricCanvases[i];
            const pdfPage = pdfPages[i];
            const { width, height } = pdfPage.getSize();

            const objects = fCanvas.getObjects();
            for (const obj of objects) {
                if (obj.type === 'i-text') {
                    pdfPage.drawText(obj.text, {
                        x: (obj.left * width) / fCanvas.width,
                        y: height - ((obj.top * height) / fCanvas.height) - 15,
                        size: (obj.fontSize * width) / fCanvas.width,
                        color: PDFLib.rgb(0, 0, 0),
                    });
                }
            }
        }

        const pdfBytes = await pdfDocInstance.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'edited_pdf_flow.pdf';
        link.click();
        showLoader(false);
    });

    function showLoader(val) { document.getElementById('loader').style.display = val ? 'flex' : 'none'; }
    function setupCanvasEvents(c) {
        c.on('selection:created', () => document.getElementById('btn-delete').style.opacity = '1');
        c.on('selection:cleared', () => document.getElementById('btn-delete').style.opacity = '0.5');
    }
</script>

</body>
</html>
