<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PdfFlow - Professional PDF Editor</title>
    
    <!-- Sabse zaruri Libraries (Internet se connect honi chahiye) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- PDF Handling Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>

    <style>
        :root { --dark-bg: #323639; --toolbar: #202124; --accent: #00a8ff; }
        body { background: var(--dark-bg); color: white; margin: 0; font-family: sans-serif; overflow: hidden; }
        
        /* Top Navigation */
        .navbar { background: var(--toolbar); height: 55px; border-bottom: 1px solid #444; padding: 0 20px; }
        .logo { font-size: 20px; font-weight: bold; color: var(--accent); }
        
        /* Toolbar */
        .toolbar { background: #444; height: 45px; display: flex; align-items: center; padding: 0 15px; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .t-btn { background: transparent; border: none; color: #ccc; padding: 5px 12px; border-radius: 4px; cursor: pointer; }
        .t-btn:hover { background: #555; color: white; }
        .t-btn.active { background: var(--accent); color: white; }

        /* Viewer Area */
        #viewer-container { height: calc(100vh - 100px); overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .page-container { position: relative; background: white; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        canvas { display: block; }
        .fabric-canvas { position: absolute; top: 0; left: 0; z-index: 5; }

        /* Upload Screen */
        #upload-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 100; }
        .upload-box { border: 2px dashed #666; padding: 50px; border-radius: 15px; background: #2a2a2a; cursor: pointer; transition: 0.3s; }
        .upload-box:hover { border-color: var(--accent); background: #333; }

        /* Loader */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<!-- Loader -->
<div id="loading-overlay">
    <div class="spinner-border text-info mb-3"></div>
    <h5>Processing PDF... Please wait</h5>
</div>

<!-- Header -->
<div class="navbar d-flex align-items-center justify-content-between">
    <div class="logo"><i class="bi bi-file-pdf"></i> PdfFlow</div>
    <div>
        <button class="btn btn-sm btn-outline-light me-2" onclick="document.getElementById('fileInput').click()">Open New File</button>
        <button class="btn btn-sm btn-primary" onclick="exportPDF()"><i class="bi bi-download"></i> Save & Download</button>
    </div>
</div>

<!-- Tools -->
<div class="toolbar">
    <button class="t-btn active" id="btn-select" onclick="changeTool('select')"><i class="bi bi-cursor"></i> Select</button>
    <button class="t-btn" id="btn-text" onclick="changeTool('text')"><i class="bi bi-type"></i> Add Text</button>
    <button class="t-btn" id="btn-draw" onclick="changeTool('draw')"><i class="bi bi-pencil"></i> Draw</button>
    <div class="vr mx-2 bg-secondary"></div>
    <button class="t-btn text-danger" onclick="deleteActive()"><i class="bi bi-trash"></i> Delete</button>
</div>

<!-- Workspace -->
<div id="viewer-container">
    <div id="upload-screen">
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <i class="bi bi-cloud-arrow-up-fill" style="font-size: 4rem; color: #00a8ff;"></i>
            <h3 class="mt-3">Import PDF File</h3>
            <p class="text-muted">Click here to start editing your PDF</p>
        </div>
    </div>
    <div id="pdf-pages-list"></div>
</div>

<input type="file" id="fileInput" hidden accept="application/pdf">

<script>
    // PDF.js setup
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let pdfData = null;
    let pdfLibDoc = null;
    let fabricInstances = [];
    let currentTool = 'select';

    // 1. File Upload Function
    document.getElementById('fileInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        toggleLoader(true);
        document.getElementById('upload-screen').style.display = 'none';
        
        try {
            const arrayBuffer = await file.arrayBuffer();
            pdfData = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            
            await renderAllPages();
        } catch (err) {
            alert("Error: PDF load nahi ho saki. File check karein.");
            console.error(err);
        }
        toggleLoader(false);
    };

    // 2. Rendering Logic
    async function renderAllPages() {
        const container = document.getElementById('pdf-pages-list');
        container.innerHTML = '';
        fabricInstances = [];

        for (let i = 1; i <= pdfData.numPages; i++) {
            const page = await pdfData.getPage(i);
            const viewport = page.getViewport({ scale: 1.5 });

            // Create page div
            const pageWrapper = document.createElement('div');
            pageWrapper.className = 'page-container';
            pageWrapper.style.width = viewport.width + 'px';
            pageWrapper.style.height = viewport.height + 'px';
            container.appendChild(pageWrapper);

            // Create Canvas for PDF
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            pageWrapper.appendChild(canvas);
            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

            // Create Fabric.js Overlay
            const overlay = document.createElement('canvas');
            overlay.className = 'fabric-canvas';
            pageWrapper.appendChild(overlay);

            const fCanvas = new fabric.Canvas(overlay, {
                width: viewport.width,
                height: viewport.height,
                selection: true
            });

            fabricInstances.push(fCanvas);
            setupCanvasInteraction(fCanvas);
        }
    }

    // 3. Tool Management
    function changeTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + tool).classList.add('active');

        fabricInstances.forEach(canvas => {
            canvas.isDrawingMode = (tool === 'draw');
            canvas.selection = (tool === 'select');
            
            canvas.off('mouse:down');
            if (tool === 'text') {
                canvas.on('mouse:down', (opt) => {
                    if (opt.target) return;
                    const text = new fabric.IText('Double click to type', {
                        left: opt.pointer.x,
                        top: opt.pointer.y,
                        fontSize: 20,
                        fill: 'black',
                        fontFamily: 'Arial'
                    });
                    canvas.add(text);
                    changeTool('select');
                });
            }
        });
    }

    function deleteActive() {
        fabricInstances.forEach(c => {
            const active = c.getActiveObject();
            if (active) c.remove(active);
        });
    }

    // 4. Export & Save
    async function exportPDF() {
        if (!pdfLibDoc) return;
        toggleLoader(true);

        const pages = pdfLibDoc.getPages();
        
        for (let i = 0; i < fabricInstances.length; i++) {
            const fCanvas = fabricInstances[i];
            const pdfPage = pages[i];
            const { width, height } = pdfPage.getSize();

            const objects = fCanvas.getObjects();
            for (const obj of objects) {
                if (obj.type === 'i-text' || obj.type === 'text') {
                    // Map browser pixels to PDF points
                    pdfPage.drawText(obj.text, {
                        x: (obj.left * width) / fCanvas.width,
                        y: height - ((obj.top * height) / fCanvas.height) - ((obj.fontSize * height) / fCanvas.height),
                        size: (obj.fontSize * width) / fCanvas.width,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                }
            }
        }

        const pdfBytes = await pdfLibDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "Edited_By_PdfFlow.pdf";
        link.click();
        toggleLoader(false);
    }

    function toggleLoader(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }

    function setupCanvasInteraction(c) {
        c.on('object:added', () => c.renderAll());
    }
</script>

</body>
</html>
